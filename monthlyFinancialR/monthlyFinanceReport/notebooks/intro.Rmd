---
title: "Understanding Monthly Reports"
output: 
  html_notebook: 
    number_sections: yes
    toc: yes
---

# Introduction

The monthly quadrant reports are not easy to understand. The monthly reports are in CS-doc-3799. You have to look at the version that you want. For this example, the version is http://cd-docdb.fnal.gov:8080/cgi-bin/ShowDocument?docid=3799&version=422

The list of files is,
![](images/filelist.png)

In general, ignore the document titles, like _Budget Line Item Balance_. They usually completely incorrect. Instead, focus on the file name, like `Effort YTD Dec 011117 (RC).xlsx`. This one is for SWF effort up to December. There's also a presentation that is useful for checking. Here, it is `SCD Review Jan 12 2017.pptx`

# Effort report

The talk budget and actual effort for different months. Let's see how we get these. Here's the picture from the talk.

![](images/effort.png)

In the effort spreadsheet, this is on the sheet `Combined FTE trend` with the appropriate items selected (I can get it to match the talk). Let's see where these data come from.

What is marked on the slide as _Depts included_ are really `Project Number`. The data from this sheet comes from `Combined FTE Pivot`. From there, the data source is `Combined FTEs to Pivot`. 

Let's try to reproduce some of these values. 

First, let's download the file SWF file
```{r}
library(httr)
library(readxl)
suppressMessages( library(dplyr) )
library(tidyr)
```

TODO - note that date in the file name changes too!
```{r}
url <- 'http://cd-docdb.fnal.gov:8080/cgi-bin/RetrieveFile?docid=3799&filename=Effort%20YTD%20Dec%20011117%20%28RC%29.xlsx&version=422'
tmp <- tempfile(fileext = '.xlsx')
GET(url, write_disk(tmp), authenticate('cdweb', 'cdpass'))
```

And open the `Data` sheet. There is some confusion when the sheet switches from budget to actual, so we need to specify columns types. Avoid importing a column by setting its type to blank. 

```{r}
coltypes <- c(rep('blank', 8), rep('text', 16), rep('numeric', 2), 'text', 'text', 'numeric', 
              rep('text', 7), rep('numeric', 3), rep('text', 3), rep('numeric', 3), 'text', 
              rep('numeric', 6), rep('text', 3), rep('blank', 15), rep('text', 10))
d <- read_excel(tmp, 'Data', col_types = coltypes)
```

```{r}
glimpse(d)
```

## Recorded Effort

Some notes, `BLI Number` is always blank. Instead, use `bgt_ItemID`. `Project` 9999 is sick, vacation or "opto" time (have to parse `Activity Name` to figure out which).

Let's pull out effort information infomation about me. 

```{r}
nNonPeriodCols = 4
d %>% filter(`Employee Name` == 'PARA, ADAM', `Record Type` == 'Effort', `Project Number` != 9999) %>% 
  select(  activity = `Activity Name`, project = `Project Number`,srv = ServiceType, bnr = `BNR CATEGORY`,
           period = eft_ReportingPeriod, fte = eft_YTDAdjustedEffortyrs ) -> d1
d1
```

 Note that rows are repeated. There's an entry per week (the period doesn't include the week). Let's group over period.
 
```{r}
d1 %>% group_by(activity, project, srv, bnr, period) -> d1g
d1g %>% summarize(fte = sum(fte)) -> d1s
d1s
```
 
 
 Let's see if we can match the `Combinded FTE Trend` sheet. We need to spread the dates. See http://stackoverflow.com/questions/35575910/calculate-subtotals-with-dplyr-and-tidyr for how to add the margins (a little tricky).

```{r}
notThese = -1:(-1*nNonPeriodCols)
d1s %>% spread(period, fte, fill = 0.0) %>% 
  ungroup() %>% 
  mutate( Total = rowSums(.[notThese])) %>% 
  rbind(., data.frame(activity='Total', project="", srv="", bnr="", 
                      t(colSums(.[notThese])), check.names = F, fix.empty.names=F))
```

Would be nice to somehow automate the adding of `activity`, `project`, and `srv` for the margins. 

## Budgeted Effort

Let's try to get the budget layout for a person. Then we'll try for an activity.

```{r}
d %>% filter(`Employee Name` == 'PARA, ADAM', `Record Type` == 'Budget') %>% 
  select(  activity = `Activity Name`, project = `Project Number`,srv = ServiceType, bnr = `BNR CATEGORY`,
           fte = bgt_FTE, cost = bgt_Budget_entered ) -> b
b
```

## Budget totals for DOE Competence

For the DOE competence project I need sum FTEs for various competencies

Let's get a list of all the unique activities that are budgeted.

```{r}
d %>% filter(`Record Type` == 'Budget') %>% 
      select(activity = `Activity Name`, act0 = `Activity Level 0`,
              act1 = `Activity Level 1`, act2 = `Activity Level 2`,
              div = ActOwningOUlevel1, quadrant = ActOwningOUlevel2, dept = ActOwningOUlevel3,
              project = `Project Number`, srv = ServiceType, bnr = `BNR CATEGORY`
             ) %>% 
      distinct(activity, .keep_all=T) %>% 
      arrange(div, quadrant, dept, activity) -> acts
```

Let's pick one for testing...

```{r}
acts %>% filter(act0 == 'SCIENTIFIC SOFTWARE', act2 == 'Frameworks', project != 583)
```

Ok - What we really want is the FTE and money level for each activity (add up over people). We can remove the distinct verb and then do group by

```{r}
d %>% filter(`Record Type` == 'Budget') %>% 
      select(activity = `Activity Name`, act0 = `Activity Level 0`, act1 = `Activity Level 1`, 
             act2 = `Activity Level 2`, act3 = `Activity Level 3`,
             div = ActOwningOUlevel1, quadrant = ActOwningOUlevel2, dept = ActOwningOUlevel3,
             project = `Project Number`, srv = ServiceType, bnr = `BNR CATEGORY`, who = `Employee Name`,
             fte = bgt_FTE, cost = bgt_Budget_entered
             ) %>% 
      group_by(activity) -> actg
```

```{r}
actg %>% summarise( nPeople = n(), fte = sum(fte)) -> actg_byact
head(actg_byact)
```
The above leaves out the columns that I want to see

```{r}
actg %>% mutate( nPeople = n(), sumFTE = sum(fte), 
                 sumCost=sum(cost)) %>% slice(1) %>% select(-who, -fte, -cost) ->  byact
head(byact)
```
The above keeps the columns, but also keeps the employee name which doesn't work. So it is removed. 

That looks good! 



### Data Analytics Software Infrastructure Support

Should include all art, CMSSW, LArSoft, and Geant support (including Phillipe for Root). What about Cosmosis?

art and CMSSW are (not CompHEP money on 583),
```{r}
byact %>% filter(act0 == 'SCIENTIFIC SOFTWARE', act2 == 'Frameworks', project != 583) -> infra1
infra1
```

Panagiotis should have included (I DO NOT INCLUD THIS),
```{r}
byact %>% filter(act0 == 'SCIENTIFIC SOFTWARE', act2 == 'Frameworks', project == 583)
```
Why is the department SCS for art R&D?

```{r}
actg %>% filter(act0 == 'SCIENTIFIC SOFTWARE', act2 == 'Frameworks', project == 583) %>% select(activity, dept, who, fte)
```
Hmm - the department is wrong for lots of people in SSI!!! Harumph. 

LArSoft is
```{r}
byact %>% filter(act0 == 'SCIENTIFIC SOFTWARE', act2 == 'larsoft', is.na(act3) | act3 != 'Project Management') ->
      infra2
infra2
```
The management part should not be included. 

Geant support is (I'm assuming I don't include Genie nor Pythia)
```{r}
byact %>% filter(act0 == "EXPERIMENT MODELING", act1 == 'Operations', act2 == 'Geant4' | act2 == 'CMS') -> infra3
infra3
```

Where is Phillipe's Root work?
```{r}
actg %>% filter(who == 'CANAL, PHILIPPE')
```
So, 

```{r}
byact %>% filter(act0 == 'SCIENTIFIC SOFTWARE', act1 == 'Operations', act2 == 'ROOT') -> infra4
infra4
```

Including Cosmosis give,
```{r}
byact %>% filter(act0 == 'SCIENTIFIC SOFTWARE', act3 == 'CosmoSIS') -> infra5
infra5
```

Add them up!

```{r}
infra <- rbind(infra1, infra2, infra3, infra4, infra5)
infra %>% select(activity, project, bnr, srv, nPeople, sumFTE, sumCost)
```

And the answers!

```{r}
infra %>% ungroup %>% summarise(totalFTE = sum(sumFTE), totalCost = sum(sumCost))
```

### Physics modeling

Accelerator modeling. Everything but management

```{r}
byact %>% filter(act0 == 'ACCELERATOR MODELING', act1 != 'Management', act1 != 'Science') -> modl1
modl1
```

Pythia - What does Mrenna report to?

```{r}
actg %>% filter( who == 'MRENNA, STEPHEN' | who == 'PERDUE, GABRIEL')
```

```{r}
byact %>% filter(act0 == 'EXPERIMENT MODELING', act1 == 'Operations', act2 %in% c('Pythia', 'Genie')) -> modl2
modl2
```

Why is Genie four people?

```{r}
actg %>% filter( activity == 'EXPERIMENT MODELING / Operations / Genie')
```
It's really three (Julia is zero - Gabe, Steve and Rob Hatcher)

All I need left is Geant R&D

```{r}
byact %>% filter(activity == 'EXPERIMENT MODELING / Project / Geant4 / RandD') -> modl3
modl3
```
Add them up!

```{r}
modl <- rbind(modl1, modl2, modl3)
modl %>% select(activity, project, bnr, srv, nPeople, sumFTE, sumCost)
```

And the answers!

```{r}
modl %>% ungroup %>% summarise(totalFTE = sum(sumFTE), totalCost = sum(sumCost))
```

# M&S Report

Let's look at M&S. There is a special spreadsheet for that. 

```{r}
url <- 'http://cd-docdb.fnal.gov:8080/cgi-bin/RetrieveFile?docid=3799&filename=BLIMiserComparison20170123.xlsx&version=424'
tmp <- tempfile(fileext = '.xlsx')
GET(url, write_disk(tmp), authenticate('cdweb', 'cdpass'))
```

## Budget 

Let's load the budget data. The `BIData` spreadsheet is quite complicated and mixes SWF and M&S data. We only really want to see the M&S data. Row 7 of the current sheet is M&S, so let's use that to get the column types.

```{r}
coltypes <- readxl:::xlsx_col_types(path=tmp, sheet = readxl:::excel_sheets(tmp) %>% 
            match("BIData", .) - 1, nskip = 6, n = 1)  
            # sheet for xlsx_col_types starts at 0, not 1 as for read_excel

b <- read_excel(tmp, 'BIData', col_types = coltypes)

b %>% filter( Expenditure_Category == 'M&S' ) -> b
head(b)
```

Let's look at all of SSI

```{r}
b %>% filter( `Budget Requesting Org` == 'SSI')
```

What's the total? The `CALC` column is the item cost times the number of items times approval flags. 

```{r}
b %>% filter( `Budget Requesting Org` == 'SSI') %>% summarise(sum(CALC))
```

Let's do this for the SSA departments (SSI, RSE, SCS). [Strangely, RSE is not in the Department acronym list]

```{r}
b %>% filter( `Budget Requesting Org` %in% c("SSI", "RSE", "SCS")) %>% 
  group_by(`Budget Requesting Org`) %>% 
  summarise(sum(CALC), sum(TotalCost))
```

Let's break this up by Expenditure type (let's join type and subtype)

```{r}
b %>% unite(expType, `CD Expenditure Type`, `CD Expenditure Subtype`, sep=' ', remove=F) -> b
```


```{r}
b %>% group_by(`Budget Requesting Org`, expType ) %>% summarise(cost = sum(CALC)) %>% 
  filter(`Budget Requesting Org` %in% c("SSI", "RSE", "SCS")) -> mands

mands
```

Totals

```{r}
mands %>% summarise(totalCost = sum(cost))
```

And all of SSA?

```{r}
mands %>% summarise( totalCost = sum(cost) ) %>% summarise(sum(totalCost))
```

## Totals for DOE Competence thing...

We can use the data frames we made for SWF to get activity names

```{r}
infra$activity
```

For Data Analytics Software...

```{r}
b %>% filter( req_Activity_Name %in% infra$activity, Item_description != 'Reserve M&S') %>% 
      select( req_Activity_Name, Item_description, 
              `Budget Requesting Org`, expType, TotalCost) %>% 
      group_by(`Budget Requesting Org`, expType)-> bInfra
bInfra
```

Summarize by Expenditure type and add margin total

```{r}
totalLastColumn <- function(df) {
  tmpdf <- data.frame( list( as.list(rep('Total', ncol(df)-1)), 
                             colSums(df[ncol(df)])), check.names = F)
  names(tmpdf) <- names(df)
  bind_rows(df, tmpdf)
}

```



```{r}
bInfra %>% summarise(sum(TotalCost)) -> bInfraET

totalLastColumn(bInfraET)

```
What are the SDCS entries?

```{r}
b %>% filter(`Budget Requesting Org` == 'SDCS', 
             req_Activity_Name == 'SCIENTIFIC SOFTWARE / Project / larsoft') %>% select(itemID, 
                                              Item_description, Item_notes, TotalCost)
```
So the LArSoft items are for Vito. 

Let's try the other one...

```{r}
b %>% filter( req_Activity_Name %in% modl$activity, Item_description != 'Reserve M&S') %>% 
      select( req_Activity_Name, Item_description, 
              `Budget Requesting Org`, expType, TotalCost) %>% 
      group_by(`Budget Requesting Org`, expType)-> bModl
bModl
```

Total totals,

```{r}
bModl %>% summarise(sum(TotalCost)) -> bModl

totalLastColumn(bModl)

```
