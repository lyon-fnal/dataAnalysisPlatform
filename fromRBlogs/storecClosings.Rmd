---
title: "Store closings"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

Following along at https://rud.is/b/2017/03/19/exploring-2017-retail-store-closings-with-r/ and http://rpubs.com/hrbrmstr/stores_2017 and 

```{r}
library(httr)
library(rvest)
library(knitr)
library(kableExtra)
library(ggalt)
library(statebins)
library(hrbrthemes)
library(purrr)
library(readr)
library(dplyr)
library(epidata)
```
```{r}
update_geom_font_defaults(font_rc_light, size = 2.75)
options(knitr.table.format = "html")
```

The Boston Globe has a nice list of store closings. 

```{r}
closings <- list(
  kmart = "https://www.bostonglobe.com/metro/2017/01/05/the-full-list-kmart-stores-closing-around/4kJ0YVofUWHy5QJXuPBAuM/story.html",
  sears = "https://www.bostonglobe.com/metro/2017/01/05/the-full-list-sears-stores-closing-around/yHaP6nV2C4gYw7KLhuWuFN/story.html",
  macys = "https://www.bostonglobe.com/metro/2017/01/05/the-full-list-macy-stores-closing-around/6TY8a3vy7yneKV1nYcwY7K/story.html",
    jcp = "https://www.bostonglobe.com/business/2017/03/17/the-full-list-penney-stores-closing-around/vhoHjI3k75k2pSuQt2mZpO/story.html"
)
```

We'll store to a file only if it isn't there.
```{r}
saved_pgs <- "saved_store_urls.rds"
```

```{r}
if (file.exists(saved_pgs)) {
  pgs <- readr::read_rds(saved_pgs)
} else {
  pgs <- purrr::map(closings, httr::GET)
  readr::write_rds(pgs, saved_pgs)  # from readr - writes a single object without compression (space is cheap)
}
```

What did we get?
```{r}
purrr::map(pgs, httr::content) 
```
```{r}
purrr::map(pgs, httr::content) %>% 
  purrr::map(rvest::html_table) %>% 
  purrr::walk(~dplyr::glimpse(.[[1]]))
```

Normalize these lists.

```{r}
map(pgs, content) %>%
  map(html_table) %>%
  map(~.[[1]]) %>%
  map_df(select, abb=3, .id = "store") -> closings
```

Just get count of stores...

```{r}
count(closings, abb) %>%
  left_join(data_frame(name = state.name, abb = state.abb)) %>%
  left_join(usmap::statepop, by = c("abb"="abbr")) %>%   # must install usmap package
  mutate(per_capita = (n/pop_2015) * 1000000) %>%
  select(name, n, per_capita) -> closings_by_state
```
```{r}
closings_by_state
```

## 2017 Retail Stores (Combined) Closing {.tabset .tabset-fade .tabset-pills}

Sears, JC Penny, K-Mart and Macy's are closing stores

### Sorted by closigs per-capita (1MM)

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;"><tr><td>

```{r sb1, echo=FALSE, fig.width=7, fig.height=5}
statebins_continuous(closings_by_state, state_col="name", value_col="per_capita", 
          legend_title = "Closings per-capita (1MM)")
```

</td></tr></table>

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;"><tr><td>

```{r chart1, echo=FALSE, fig.width=7, fig.height=8}
arrange(closings_by_state, per_capita) %>%
  mutate(name = factor(name, name)) %>%
  ggplot(aes(per_capita, name)) +
  geom_lollipop(horizontal = TRUE) +
  scale_x_continuous(name="Closings per capita (1MM)", expand=c(0,0), limits=c(0,7.5)) +
  geom_label(aes(label=sprintf("%1.2f (n=%d)", per_capita, n)),
             hjust=0, nudge_x=0.1, label.size=0) +
  labs(y=NULL) +
  theme_ipsum_rc(grid="X") +
  theme(axis.text.x=element_blank())
```

</td></tr></table>

```{r table1, echo=FALSE}
arrange(closings_by_state, desc(per_capita)) %>%
  select(State=name, `Total Stores Closing`=n, `Per Capita (1MM)`=per_capita) %>%
  kable(align = "lrr", caption="Retail Stores Closing (sorted by per-capita)") %>%
  kable_styling(full_width = FALSE, bootstrap_options = "condensed")  # Note the option above for html tables
```

### Sorted by total stores closing

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;"><tr><td>

```{r sb2, echo=FALSE, fig.width=7, fig.height=5}
statebins_continuous(closings_by_state, state_col="name", value_col="n", 
          legend_title = "Total closings per-state")
```

</td></tr></table>

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;"><tr><td>

```{r chart2, echo=FALSE, fig.width=7, fig.height=8}
arrange(closings_by_state, n) %>%
  mutate(name = factor(name, name)) %>%
  ggplot(aes(n, name)) +
  geom_lollipop(horizontal = TRUE) +
  scale_x_continuous(name="Total closings", expand=c(0,0), limits=c(0,30)) +
  geom_label(aes(label=n), hjust=0, nudge_x=0.25, label.size=0) +
  labs(y=NULL) +
  theme_ipsum_rc(grid="X") +
  theme(axis.text.x=element_blank())
```

</td></tr></table>

```{r table2, echo=FALSE}
arrange(closings_by_state, desc(n)) %>%
  select(State=name, `Total Stores Closing`=n, `Per Capita (1MM)`=per_capita) %>%
  kable(align = "lrr", caption="Retail Stores Closing (sorted by total stores)") %>%
  kable_styling(full_width = FALSE, bootstrap_options = "condensed")
```

### Sorted by state name

```{r table3, echo=FALSE}
arrange(closings_by_state, name) %>%
  select(State=name, `Total Stores Closing`=n, `Per Capita (1MM)`=per_capita) %>%
  kable(align = "lrr", caption="Retail Stores Closing (sorted by state name)") %>%
  kable_styling(full_width = FALSE, bootstrap_options = "condensed")
```

## Compared to unemployment

I'd have used the [`epidata`](https://cran.rstudio.com/web/packages/epidata/) to get the current state unemployment data but it's not current, so we can either use a package to get data from the Bureau of Labor Statistics or just scrape it. We'll use the U-6 rate since that is an expanded definition including _"total unemployed, plus all marginally attached workers, plus total employed part time for economic reasons, as a percent of the civilian labor force plus all marginally attached workers"_ and is likely to more representative for the populations working at retail chains.

```{r bls, fig.width=8, fig.height=7}
pg <- read_html("https://www.bls.gov/lau/stalt16q4.htm")

html_nodes(pg, "table#alternmeas16\\:IV") %>% 
  html_table(header = TRUE, fill = TRUE) %>%
  .[[1]] %>% 
  docxtractr::assign_colnames(1) %>% 
  rename(name=State) %>% 
  as_data_frame() %>% 
  slice(2:52) %>% 
  type_convert() %>% 
  left_join(closings_by_state, by="name") %>% 
  filter(!is.na(n)) -> with_unemp

ggplot(with_unemp, aes(per_capita, `U-6`)) +
  geom_label(aes(label=name), fill="#8c96c6", color="white", size=3.5, family=font_rc) +
  scale_x_continuous(limits=c(-0.125, 6.75)) +
  labs(x="Closings per-capita (1MM)", 
       y="BLS Labor Underutilization (U-6 rate)",
       title="Per-capita store closings compared to current BLS U-6 Rate") +
  theme_ipsum_rc(grid="XY")
```


If I were a reporter, I think I'd be digging a bit deeper on the impact of these (and the half-dozen or so other) retailers closing locations in New Mexico, Nevada, West Virginia, Wyoming, (mebbe Maine, though I'm super-b ased :-), North Dakota & South Dakota.